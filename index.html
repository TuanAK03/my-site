<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chat bot</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="main-layout">
        <div id="sidebar">
            <h3>Tu·ª≥ ch·ªçn nhanh</h3>
            <button class="option-btn" onclick="quickAsk('Gi·ªõi thi·ªáu v·ªÅ b·∫°n')">Gi·ªõi thi·ªáu v·ªÅ b·∫°n</button>
            <button class="option-btn" onclick="quickAsk('H√¥m nay c√≥ tin t·ª©c g√¨ hot?')">Tin t·ª©c h√¥m nay</button>
            <button class="option-btn" onclick="quickAsk('K·ªÉ m·ªôt c√¢u chuy·ªán vui')">K·ªÉ chuy·ªán vui</button>
            <button class="option-btn" onclick="quickAsk('G·ª£i √Ω m√≥n ƒÉn t·ªëi nay')">G·ª£i √Ω m√≥n ƒÉn</button>
            <button class="option-btn" onclick="quickAsk('T∆∞ v·∫•n h·ªçc l·∫≠p tr√¨nh')">T∆∞ v·∫•n l·∫≠p tr√¨nh</button>
        </div>
        <div id="chat-container">
            <h2>B·ªë Tu·∫•n test AI</h2>
            <div id="top-tools">
                <button id="reset-btn">Xo√° h·ªôi tho·∫°i</button>
                <button id="retry-btn">G·ª≠i l·∫°i</button>
                <button id="download-btn">T·∫£i l·ªãch s·ª≠</button>
                <button id="dark-btn">üåô/‚òÄÔ∏è</button>
                <select id="model-select">
                    <option value="gemini-2.0-flash">Gemini Flash</option>
                    <option value="gemini-pro">Gemini Pro</option>
                </select>
            </div>
            <div id="status-bar"></div>
            <input type="text" id="search-input" placeholder="T√¨m ki·∫øm h·ªôi tho·∫°i...">
            <div id="chat-box"></div>
            <div id="input-area">
                <input type="text" id="user-input" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
                <button id="mic-btn" title="Nh·∫≠p b·∫±ng gi·ªçng n√≥i">üé§</button>
                <button id="send-btn">G·ª≠i</button>
            </div>
        </div>
    </div>
    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const resetBtn = document.getElementById('reset-btn');
        const downloadBtn = document.getElementById('download-btn');
        const retryBtn = document.getElementById('retry-btn');
        const darkBtn = document.getElementById('dark-btn');
        const modelSelect = document.getElementById('model-select');
        const statusBar = document.getElementById('status-bar');
        const searchInput = document.getElementById('search-input');
        const micBtn = document.getElementById('mic-btn');

        let chatHistory = [];
        let lastUserMsg = '';

        // L∆∞u v√† t·∫£i l·ªãch s·ª≠ chat t·ª´ LocalStorage
        function saveHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }
        function loadHistory() {
            const data = localStorage.getItem('chatHistory');
            if (data) {
                chatHistory = JSON.parse(data);
                chatBox.innerHTML = '';
                chatHistory.forEach(item => appendMessage(item.role === 'user' ? 'user' : 'bot', item.text, item.time, true));
            }
        }
        window.addEventListener('load', loadHistory);

        function formatTime(date) {
            return new Date(date).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        }

        function appendMessage(sender, text, time = null, skipSave = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + sender;
            msgDiv.textContent = (sender === 'user' ? 'B·∫°n: ' : 'Bot: ') + text;
            if (!time) time = new Date();
            const timeSpan = document.createElement('span');
            timeSpan.className = 'timestamp';
            timeSpan.textContent = formatTime(time);
            msgDiv.appendChild(timeSpan);
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            if (!skipSave) saveHistory();
        }

        function setStatus(text) {
            statusBar.textContent = text;
        }

        async function botReplyGemini(message, retry = false) {
            if (!retry) chatHistory.push({ role: 'user', text: message, time: new Date().toISOString() });
            setStatus('‚è≥ ƒêang g·ª≠i y√™u c·∫ßu...');
            try {
                const res = await fetch('http://localhost:3000/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        history: chatHistory,
                        model: modelSelect.value
                    })
                });
                const data = await res.json();
                chatHistory.push({ role: 'bot', text: data.reply, time: new Date().toISOString() });
                setStatus('‚úÖ ƒê√£ nh·∫≠n ph·∫£n h·ªìi');
                saveHistory();
                return data.reply;
            } catch (e) {
                setStatus('‚ùå L·ªói k·∫øt n·ªëi t·ªõi server!');
                return 'L·ªói k·∫øt n·ªëi t·ªõi server!';
            }
        }

        sendBtn.onclick = async () => {
            const msg = userInput.value.trim();
            if (!msg) return;
            lastUserMsg = msg;
            appendMessage('user', msg);
            appendMessage('bot', 'ƒêang tr·∫£ l·ªùi...');
            userInput.value = '';
            userInput.focus();
            const botMsg = await botReplyGemini(msg);
            chatBox.lastChild.remove();
            appendMessage('bot', botMsg);
        };

        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') sendBtn.click();
        });

        function quickAsk(text) {
            userInput.value = text;
            sendBtn.click();
        }

        resetBtn.onclick = () => {
            chatHistory = [];
            chatBox.innerHTML = '';
            saveHistory();
        };

        retryBtn.onclick = async () => {
            if (!lastUserMsg) return;
            // Xo√° 2 tin cu·ªëi (user, bot) kh·ªèi l·ªãch s·ª≠ v√† khung chat
            if (chatHistory.length >= 2) chatHistory.splice(-2, 2);
            if (chatBox.childNodes.length >= 2) {
                chatBox.removeChild(chatBox.lastChild);
                chatBox.removeChild(chatBox.lastChild);
            }
            appendMessage('user', lastUserMsg);
            appendMessage('bot', 'ƒêang tr·∫£ l·ªùi...');
            const botMsg = await botReplyGemini(lastUserMsg, true);
            chatBox.lastChild.remove();
            appendMessage('bot', botMsg);
        };

        downloadBtn.onclick = () => {
            let text = '';
            chatHistory.forEach(item => {
                const who = item.role === 'user' ? 'B·∫°n' : 'Bot';
                text += `[${who}] ${item.text}\n`;
            });
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lich_su_chat.txt';
            a.click();
            URL.revokeObjectURL(url);
        };

        darkBtn.onclick = () => {
            document.body.classList.toggle('dark');
        };

        // T√¨m ki·∫øm trong l·ªãch s·ª≠ chat
        searchInput.oninput = function() {
            const q = this.value.trim().toLowerCase();
            chatBox.innerHTML = '';
            chatHistory.forEach(item => {
                if (item.text.toLowerCase().includes(q)) {
                    appendMessage(item.role === 'user' ? 'user' : 'bot', item.text, item.time, true);
                }
            });
            if (!q) loadHistory();
        };

        // G·ª≠i tin nh·∫Øn b·∫±ng gi·ªçng n√≥i (Speech-to-Text)
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'vi-VN';
            recognition.continuous = false;
            recognition.interimResults = false;
            micBtn.onclick = () => {
                recognition.start();
                setStatus('üé§ ƒêang nghe...');
            };
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                setStatus('‚úÖ ƒê√£ nh·∫≠n gi·ªçng n√≥i');
            };
            recognition.onerror = function() {
                setStatus('‚ùå Kh√¥ng nh·∫≠n ƒë∆∞·ª£c gi·ªçng n√≥i');
            };
        } else {
            micBtn.style.display = 'none';
        }

        // Desktop notification khi c√≥ tin nh·∫Øn m·ªõi (n·∫øu c·ª≠a s·ªï b·ªã ·∫©n)
        if ('Notification' in window) {
            Notification.requestPermission();
        }
        function notifyNewBotMsg(msg) {
            if (document.hidden && Notification.permission === 'granted') {
                new Notification('Bot tr·∫£ l·ªùi', { body: msg });
            }
        }
        // G·ªçi notifyNewBotMsg trong appendMessage cho bot
        const oldAppendMessage = appendMessage;
        appendMessage = function(sender, text, time = null, skipSave = false) {
            oldAppendMessage(sender, text, time, skipSave);
            if (sender === 'bot') notifyNewBotMsg(text);
        };
    </script>
</body>
</html>